<!--
SPDX-FileCopyrightText: Copyright (c) 2025 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
SPDX-License-Identifier: Apache-2.0

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live VLM WebUI - College of Staten Island</title>

    <!-- Favicons -->
    <link rel="icon" type="image/svg+xml" href="favicon/favicon.svg">
    <link rel="icon" type="image/x-icon" href="favicon/favicon.ico">
    <link rel="icon" type="image/png" sizes="96x96" href="favicon/favicon-96x96.png">
    <link rel="apple-touch-icon" sizes="180x180" href="favicon/apple-touch-icon.png">
    <link rel="manifest" href="favicon/site.webmanifest">

    <style>
        :root {
            /* CSI Brand Colors (Light Blue Accents) */
            --csi-blue: #009CDE;
            --csi-blue-dark: #007BAF;
            --csi-blue-light: #33B0E5;

            /* Dark theme (default) */
            --bg-primary: #000000;
            --bg-secondary: #111111;
            --bg-tertiary: #1A1A1A;
            --text-primary: #FFFFFF;
            --text-secondary: #CCCCCC;
            --text-muted: #999999;
            --border-color: #333333;
            --card-bg: #111111;
            --card-hover: #1A1A1A;
            --accent-color: var(--csi-blue);
            --accent-hover: var(--csi-blue-dark);
            --warning-color: #FFA726;
            --error-color: #EF5350;
        }

        body.light-theme {
            /* Light theme */
            --bg-primary: #FFFFFF;
            --bg-secondary: #F8F8F8;
            --bg-tertiary: #F0F0F0;
            --text-primary: #000000;
            --text-secondary: #333333;
            --text-muted: #666666;
            --border-color: #E0E0E0;
            --card-bg: #FFFFFF;
            --card-hover: #F8F8F8;
            --accent-color: var(--csi-blue);
            --accent-hover: var(--csi-blue-dark);
            --warning-color: #F57C00;
            --error-color: #D32F2F;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Helvetica Neue", Helvetica, Arial, -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background 0.3s ease, color 0.3s ease;
        }

        /* Code styling for hostname */
        code {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            padding: 2px 2px;
            border-radius: 6px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            font-size: 0.8em;
            color: var(--accent-color);
            white-space: nowrap;
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 16px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            font-size: 28px;
            font-weight: 700;
            color: var(--accent-color);
            letter-spacing: -0.5px;
            line-height: 1;
        }

        .title-section h1 {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin-top: 4px;
            margin-bottom: 2px;
        }

        .cuny-brand {
            font-family: "Akzidenz-Grotesk BQ Light", "Akzidenz-Grotesk BQ Light Condensed", "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, sans-serif;
            font-weight: 300;
            font-size: 11px;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            text-transform: uppercase;
            line-height: 1.1;
        }

        .csi-brand {
            font-family: "Akzidenz-Grotesk BQ Medium", "Akzidenz-Grotesk BQ Bold", "Helvetica Neue Bold", "Helvetica Neue", Helvetica, Arial, sans-serif;
            font-weight: 700;
            font-size: 15px;
            color: var(--text-primary);
            line-height: 1.1;
        }

        .title-section .subtitle {
            font-size: 12px;
            color: var(--text-muted);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .theme-toggle {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .theme-toggle:hover {
            background: var(--card-hover);
        }

        .settings-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
        }

        .settings-btn:hover {
            background: var(--card-hover);
        }

        /* Settings Modal */
        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .settings-modal.show {
            display: flex;
        }

        .settings-dialog {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            width: 90%;
            max-width: 900px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .settings-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .settings-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .settings-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .settings-close:hover {
            background: var(--bg-tertiary);
        }

        .settings-body {
            padding: 24px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 32px;
        }

        .settings-section {
            margin-bottom: 24px;
        }

        .settings-section:last-child {
            margin-bottom: 0;
        }

        /* Full width section for sections that need it */
        .settings-section.full-width {
            grid-column: 1 / -1;
        }

        .settings-section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
            gap: 16px;
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-item-label {
            font-size: 14px;
            color: var(--text-primary);
        }

        .settings-item > div:first-child {
            flex: 1;
            min-width: 0;
        }

        .settings-item-description {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            width: 48px;
            height: 26px;
            flex-shrink: 0;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            transition: 0.3s;
            border-radius: 26px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: var(--text-secondary);
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(22px);
            background-color: white;
        }

        /* Settings Dropdown */
        .settings-select {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            width: 180px;
            flex-shrink: 0;
        }

        .settings-select:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        /* Main Layout */
        .container {
            display: flex;
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 350px;
            min-width: 250px;
            max-width: 600px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            overflow-x: visible;
            padding: 20px;
            position: relative;
            flex-shrink: 0;
        }

        .sidebar.hidden {
            width: 0 !important;
            min-width: 0 !important;
            padding: 0 !important;
            opacity: 0 !important;
            pointer-events: none !important;
            border-right: none !important;
        }

        .sidebar-resize-handle {
            position: absolute;
            top: 0;
            right: 0;
            width: 5px;
            height: 100%;
            cursor: ew-resize;
            background: transparent;
            transition: background 0.2s;
            z-index: 100;
        }

        .sidebar-resize-handle:hover,
        .sidebar-resize-handle.dragging {
            background: var(--accent-color);
        }

        .panel {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 16px;
            overflow: visible;
        }

        .panel-header {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }

        .panel-header:hover {
            background: var(--card-hover);
        }

        .panel-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .panel-icon {
            font-size: 16px;
        }

        .panel-toggle {
            color: var(--text-muted);
            font-size: 12px;
            transition: transform 0.2s;
        }

        .panel-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .panel-content {
            padding: 16px;
            max-height: 1000px;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            opacity: 1;
            overflow: visible;
        }

        .panel-content.collapsed {
            max-height: 0;
            opacity: 0;
            padding: 0 16px;
            overflow: hidden;
        }

        #apiKeyField {
            max-height: 100px;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            opacity: 1;
            overflow: hidden;
        }

        #apiKeyField.collapsed {
            max-height: 0;
            opacity: 0;
        }

        #apiKeyToggle {
            transition: transform 0.2s;
        }

        #apiKeyToggle.collapsed {
            transform: rotate(-90deg);
        }

        .form-group {
            margin-bottom: 14px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 6px;
            letter-spacing: 0.3px;
        }

        input[type="text"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 10px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
            transition: border 0.2s;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        /* Prevent browser autofill blue background */
        input:-webkit-autofill,
        input:-webkit-autofill:hover,
        input:-webkit-autofill:focus {
            -webkit-box-shadow: 0 0 0 1000px var(--bg-tertiary) inset !important;
            -webkit-text-fill-color: var(--text-primary) !important;
            transition: background-color 5000s ease-in-out 0s;
        }

        /* Disabled input styling */
        input:disabled,
        select:disabled,
        textarea:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: var(--bg-secondary);
            color: var(--text-muted);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
            line-height: 1.5;
        }

        .btn {
            width: 100%;
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            letter-spacing: 0.3px;
        }

        .btn-primary {
            background: var(--accent-color);
            color: white;
            border: 1px solid var(--accent-color);
        }

        .btn-primary:hover {
            background: var(--accent-hover);
            border-color: var(--accent-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 156, 222, 0.3);
        }

        /* Tab-style underline */
        .tab-item {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: border-color 0.2s;
        }

        .tab-item.active {
            border-bottom-color: var(--accent-color);
        }

        .tab-item:hover {
            border-bottom-color: var(--accent-hover);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--card-hover);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .icon-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            padding: 0;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .icon-btn:hover:not(:disabled) {
            background: var(--card-hover);
            border-color: var(--accent-color);
            transform: scale(1.1);
        }

        .icon-btn:active:not(:disabled) {
            transform: scale(0.95);
        }

        .icon-btn:disabled {
            cursor: not-allowed;
            opacity: 0.4;
            background: var(--bg-secondary);
        }

        .input-hint {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Input Source Tabs */
        .input-source-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 16px;
            border-bottom: 2px solid var(--border-color);
        }

        /* Beta Badge */
        .beta-badge {
            display: inline-block;
            background: var(--warning-color);
            color: #000;
            font-size: 7px;
            font-weight: 700;
            padding: 1px 1px;
            border-radius: 2px;
            margin-left: -6px;
            vertical-align: super;
            letter-spacing: 0.3px;
            transform: rotate(50deg);
            transform-origin: center;
        }

        .input-source-tab {
            flex: 1;
            padding: 10px 2px;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-muted);
            transition: all 0.2s;
        }

        .input-source-tab:hover {
            color: var(--text-primary);
            background: rgba(0, 156, 222, 0.05);
        }

        .input-source-tab.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
        }

        /* Tooltip */
        .tooltip-wrapper {
            position: relative;
            display: inline-flex;
            align-items: baseline;
            gap: 6px;
        }

        .tooltip-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: var(--border-color);
            color: var(--text-muted);
            font-size: 10px;
            font-weight: 600;
            line-height: 1;
            cursor: help;
            transition: all 0.2s;
            flex-shrink: 0;
            transform: translateY(-1px);
        }

        .tooltip-icon:hover {
            background: var(--accent-color);
            color: white;
        }

        .tooltip-text {
            visibility: hidden;
            opacity: 0;
            position: fixed;
            padding: 12px 16px;
            background: var(--card-bg);
            border: 1px solid var(--accent-color);
            border-radius: 8px;
            font-size: 12px;
            line-height: 1.6;
            color: var(--text-primary);
            white-space: normal;
            width: 380px;
            max-width: calc(100vw - 40px);
            z-index: 10000;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            transition: opacity 0.2s, visibility 0.2s;
            pointer-events: none;
        }

        .tooltip-text strong {
            color: var(--accent-color);
            font-weight: 600;
        }

        .tooltip-wrapper:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }

        .main-content.expanded {
            max-width: 100%;
        }

        /* Status Badge */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.connected {
            background: rgba(0, 156, 222, 0.15);
            color: var(--accent-color);
        }

        .status-badge.disconnected {
            background: rgba(107, 114, 128, 0.2);
            color: var(--text-muted);
        }

        .status-badge.processing {
            background: rgba(0, 156, 222, 0.15);
            color: var(--accent-color);
        }

        /* Video Display */
        .video-card {
            background: transparent;
            margin-bottom: 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .video-container {
            position: relative;
            display: inline-block;
            background: #000;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
            max-width: 100%;
            resize: both;
            min-width: 320px;
            min-height: 180px;
        }

        .video-container::-webkit-resizer {
            background: var(--accent-color);
            border-radius: 0 0 12px 0;
        }

        video {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #000;
            transition: transform 0.3s ease;
        }

        #overlayCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }

        /* Video Overlay Text */
        .video-overlay {
            position: absolute;
            left: 0;
            right: 0;
            padding: 16px 20px;
            background: linear-gradient(to bottom, rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0.4));
            color: white;
            font-size: 16px;
            line-height: 1.5;
            pointer-events: none;
            display: none;
            z-index: 10;
        }

        .video-overlay.top {
            top: 0;
            background: linear-gradient(to bottom, rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0.4));
        }

        .video-overlay.bottom {
            bottom: 0;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0.4));
        }

        .video-overlay.show {
            display: block;
        }

        video.mirrored {
            transform: scaleX(-1);
        }

        .video-controls {
            position: absolute;
            top: 12px;
            right: 12px;
            display: flex;
            gap: 8px;
            z-index: 10;
        }

        .video-control-btn {
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            backdrop-filter: blur(10px);
            transition: all 0.2s;
        }

        .video-control-btn:hover {
            background: rgba(0, 0, 0, 0.9);
            border-color: var(--accent-color);
        }

        .video-control-btn.active {
            background: var(--accent-color);
            border-color: var(--accent-color);
        }

        /* Generation Result */
        .result-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            transition: opacity 0.3s ease, filter 0.3s ease;
        }

        .result-card.cloud-api {
            opacity: 0.5;
            filter: grayscale(0.3);
        }

        /* System Stats Card */
        #systemStatsCard {
            position: relative;
            overflow: hidden;
        }

        #systemStatsCard::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            background-image: var(--system-bg-image, none);
            background-size: contain;
            background-repeat: no-repeat;
            background-position: bottom right 80px;
            opacity: 0.08;
            filter: blur(2px);
            pointer-events: none;
            z-index: 0;
        }

        body.light-theme #systemStatsCard::before {
            opacity: 0.05;
        }

        #systemStatsCard > * {
            position: relative;
            z-index: 1;
        }

        .api-preset-item {
            padding: 10px 16px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .api-preset-item:hover {
            background: var(--hover-bg);
        }

        .api-preset-item strong {
            color: var(--text-primary);
            font-size: 13px;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .result-header-left {
            flex: 1;
        }

        .result-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            letter-spacing: 0.3px;
            margin-bottom: 6px;
        }

        .result-subtitle {
            font-size: 12px;
            color: var(--text-muted);
            line-height: 1.4;
        }

        .result-prompt {
            font-size: 13px;
            color: var(--text-primary);
            margin-top: 16px;
            margin-bottom: 12px;
            margin-left: auto;
            margin-right: 0;
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 16px 16px 4px 16px;
            max-width: 85%;
            word-wrap: break-word;
        }

        .result-text {
            font-size: 15px;
            line-height: 1.6;
            color: var(--text-primary);
            transition: opacity 3s ease, transform 0.3s ease, box-shadow 0.3s ease;
            min-height: 120px;
            margin-top: 12px;
            margin-left: 0;
            margin-right: auto;
            padding: 14px 18px;
            background: linear-gradient(135deg, rgba(0, 156, 222, 0.15) 0%, rgba(147, 112, 219, 0.12) 100%);
            border: 1px solid rgba(0, 156, 222, 0.3);
            border-radius: 16px 16px 16px 4px;
            max-width: 90%;
            word-wrap: break-word;
            position: relative;
        }

        .result-text-content {
            width: 100%;
        }

        /* Embedded markdown toggle button */
        .markdown-toggle-embedded {
            position: absolute;
            top: -1px;
            right: -1px;
            background: var(--bg-secondary);
            border: 1px solid rgba(0, 156, 222, 0.3);
            border-radius: 0 16px 0 0;
            color: var(--text-secondary);
            padding: 4px 10px;
            font-size: 11px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
            z-index: 10;
            line-height: 1.2;
        }

        .markdown-toggle-embedded:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .markdown-toggle-embedded .lucide {
            width: 12px;
            height: 12px;
        }

        /* Copy button */
        .copy-button-embedded {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: 6px;
            color: var(--text-primary);
            padding: 6px 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 10;
            opacity: 0.4;
        }

        .copy-button-embedded:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.4);
            transform: scale(1.05);
        }

        .copy-button-embedded.copied {
            background: rgba(0, 156, 222, 0.6);
            border-color: rgba(0, 156, 222, 0.4);
        }

        /* Markdown styling */
        .result-text-content.markdown-rendered h1,
        .result-text-content.markdown-rendered h2,
        .result-text-content.markdown-rendered h3 {
            color: var(--text-primary);
            margin-top: 16px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .result-text-content.markdown-rendered a {
            color: var(--accent-color);
            text-decoration: none;
        }

        .result-text-content.markdown-rendered blockquote {
            border-left: 4px solid var(--accent-color);
            padding-left: 16px;
            margin: 12px 0;
            color: var(--text-secondary);
            font-style: italic;
        }

        .result-text.fade {
            opacity: 0.4;
        }

        .result-text.new-message {
            animation: popIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .result-text.new-message.with-glow {
            animation: popInWithGlow 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes popIn {
            0% { transform: scale(0.95); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes popInWithGlow {
            0% { transform: scale(0.95); opacity: 0.8; box-shadow: 0 0 0 0 rgba(0, 156, 222, 0.4); }
            50% { box-shadow: 0 0 20px 4px rgba(0, 156, 222, 0.6); }
            100% { transform: scale(1); opacity: 1; box-shadow: 0 0 0 0 rgba(0, 156, 222, 0); }
        }

        /* VLM Metrics */
        .metrics-inline {
            display: flex;
            gap: 16px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .metric-value {
            font-weight: 600;
            color: var(--accent-color);
        }

        /* System Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            letter-spacing: 0.3px;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            white-space: nowrap;
        }

        .stat-bar {
            width: 100%;
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .stat-bar-fill {
            height: 100%;
            background: var(--accent-color);
            transition: width 0.3s ease;
        }

        .sparkline {
            width: 100%;
            height: 40px;
        }

        /* Lucide icon styling */
        .lucide {
            width: 1em;
            height: 1em;
            vertical-align: middle;
        }

        .logo .lucide,
        .logo img,
        .logo svg {
            height: 42px;
            width: auto;
            display: block;
            filter: drop-shadow(0 0 8px var(--accent-color));
        }

        /* Blue focus glows */
        #promptText:focus,
        #maxTokens:focus,
        #processEvery:focus,
        #cameraSelect:focus,
        #apiBaseUrl:focus,
        #apiKey:focus,
        #modelSelect:focus,
        #rtspUrl:focus {
            border-color: var(--accent-color) !important;
            box-shadow: 0 0 0 2px rgba(0, 156, 222, 0.15),
                        0 0 8px rgba(0, 156, 222, 0.2) !important;
            outline: none;
        }

        @keyframes settingApplied {
            0% { box-shadow: 0 0 0 0 rgba(0, 156, 222, 0.7), 0 0 20px rgba(0, 156, 222, 0.8); }
            50% { box-shadow: 0 0 0 6px rgba(0, 156, 222, 0.3), 0 0 30px rgba(0, 156, 222, 0.6); }
            100% { box-shadow: 0 0 0 0 rgba(0, 156, 222, 0), 0 0 0 rgba(0, 156, 222, 0); }
        }

        .applied {
            animation: settingApplied 0.6s ease-out;
        }

    </style>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Markdown libraries -->
    <script src="https://cdn.jsdelivr.net/npm/marked@12.0.0/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => lucide.createIcons());
    </script>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <div class="logo">
                <img src="images/csi-logo.svg" alt="CSI Logo">
            </div>
            <div class="title-section">
                <div class="cuny-brand">THE CITY UNIVERSITY OF NEW YORK</div>
                <div class="csi-brand">College of Staten Island</div>
                <h1>Live VLM WebUI</h1>
                <div class="subtitle">AI Research Platform</div>
            </div>
        </div>
        <div class="header-right">
            <span class="status-badge disconnected" id="connectionStatus">Disconnected</span>
            <button class="settings-btn" id="settingsBtn" title="Settings">
                <i data-lucide="settings"></i>
            </button>
            <button class="theme-toggle" id="themeToggle">
                <span id="themeIcon"><i data-lucide="moon"></i></span>
                <span id="themeText">Dark</span>
            </button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="settings-modal" id="settingsModal">
        <div class="settings-dialog">
            <div class="settings-header">
                <div class="settings-title">
                    <i data-lucide="settings"></i> Settings
                </div>
                <button class="settings-close" id="settingsClose">×</button>
            </div>
            <div class="settings-body">
                <div>
                    <div class="settings-section">
                        <div class="settings-section-title">Layout</div>
                        <div class="settings-item">
                            <div>
                                <div class="settings-item-label">Main Content Order</div>
                            </div>
                            <select id="layoutOrder" class="settings-select">
                                <option value="video-first">Camera → VLM Output</option>
                                <option value="vlm-first" selected>VLM Output → Camera</option>
                            </select>
                        </div>
                        <div class="settings-item">
                            <div>
                                <div class="settings-item-label">VLM Output on Camera View</div>
                            </div>
                            <select id="overlayPosition" class="settings-select">
                                <option value="none">None</option>
                                <option value="top">Top</option>
                                <option value="bottom">Bottom</option>
                            </select>
                        </div>
                    </div>
                    <div class="settings-section">
                        <div class="settings-section-title">Visual Effects</div>
                        <div class="settings-item">
                            <div><div class="settings-item-label">Pop-in Animation</div></div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="popInToggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="settings-item">
                            <div><div class="settings-item-label">Glow Effect</div></div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="glowToggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="settings-item">
                            <div><div class="settings-item-label">YOLO Segmentation</div></div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="yoloToggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
                <div>
                    <div class="settings-section">
                        <div class="settings-section-title">Performance</div>
                        <div class="settings-item">
                            <div class="settings-item-label">Max Video Latency (sec)</div>
                            <input type="number" id="maxLatency" value="0" min="0" step="0.1" style="width: 80px;">
                        </div>
                    </div>
                    <!-- Hidden element for JS compatibility -->
                    <input type="checkbox" id="colorfulFocusToggle" style="display:none;">
                    <div class="settings-section">
                         <div class="settings-section-title">GPU Monitoring</div>
                         <div class="settings-item">
                             <div class="settings-item-label">Update Interval (sec)</div>
                             <input type="number" id="gpuUpdateInterval" value="0.25" min="0.1" step="0.05" style="width: 80px;">
                         </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-resize-handle" id="sidebarResizeHandle"></div>
            <div class="panel">
                <div class="panel-header" onclick="togglePanel('vlmConfig')">
                    <div class="panel-title"><i data-lucide="globe" style="margin-right:8px;"></i> VLM API Configuration</div>
                    <span class="panel-toggle" id="vlmConfigToggle">▼</span>
                </div>
                <div class="panel-content" id="vlmConfig">
                    <div class="form-group">
                        <label>API Base URL</label>
                        <div style="display: flex; align-items: center; gap: 4px;">
                            <input type="text" id="apiBaseUrl" value="http://localhost:11434/v1">
                            <button class="icon-btn" id="apiPresetsBtn" title="Presets"><i data-lucide="list"></i></button>
                        </div>
                        <div id="apiPresetsMenu" style="display: none; position: absolute; background: var(--card-bg); border: 1px solid var(--border-color); z-index: 100;">
                            <div class="api-preset-item" data-url="http://localhost:11434/v1">Ollama</div>
                            <div class="api-preset-item" data-url="http://localhost:8000/v1">vLLM</div>
                        </div>
                    </div>
                    <div class="form-group">
                         <label>Model</label>
                         <div style="display: flex; gap: 4px;">
                             <select id="modelSelect"><option>Loading...</option></select>
                             <button class="icon-btn" id="refreshModelsBtn"><i data-lucide="refresh-cw"></i></button>
                         </div>
                    </div>
                    <div id="apiKeyGroup" class="form-group">
                        <label onclick="toggleApiKeyField()" style="cursor:pointer">API Key (Optional) <span id="apiKeyToggle">▼</span></label>
                        <div id="apiKeyField" class="collapsed">
                            <input type="text" id="apiKey" placeholder="sk-...">
                        </div>
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header" onclick="togglePanel('cameraConfig')">
                    <div class="panel-title"><i data-lucide="video" style="margin-right:8px;"></i> Camera Control</div>
                    <span class="panel-toggle" id="cameraConfigToggle">▼</span>
                </div>
                <div class="panel-content" id="cameraConfig">
                    <div class="input-source-tabs">
                        <button class="input-source-tab active" data-source="webcam">Webcam</button>
                        <button class="input-source-tab" data-source="rtsp">RTSP <span class="beta-badge">BETA</span></button>
                    </div>
                    <div id="webcamControls">
                        <select id="cameraSelect"><option>Detecting...</option></select>
                    </div>
                    <div id="rtspControls" style="display:none">
                        <input type="text" id="rtspUrl" placeholder="rtsp://...">
                    </div>
                    <button class="btn btn-primary" id="startBtn" style="margin-top:10px">START ANALYSIS</button>
                    <button class="btn btn-secondary" id="stopBtn" disabled style="margin-top:5px">STOP</button>
                    <div class="form-group" style="margin-top:10px">
                        <label>Process Every Nth Frame</label>
                        <input type="number" id="processEvery" value="30">
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header" onclick="togglePanel('promptEditor')">
                    <div class="panel-title"><i data-lucide="edit-3" style="margin-right:8px;"></i> Prompt Editor</div>
                    <span class="panel-toggle" id="promptEditorToggle">▼</span>
                </div>
                <div class="panel-content" id="promptEditor">
                    <select id="promptPreset">
                        <option value="">-- Presets --</option>
                        <option value="Describe what you see in one sentence.">Brief Description</option>
                        <option value="Provide a detailed description of the scene, including objects, actions, and atmosphere.">Detailed Description</option>
                        <option value="List the main objects and people visible in this image.">Object List</option>
                        <option value="What is the main action happening in this scene?">Action Detection</option>
                        <option value="Read any text visible in the image.">OCR / Text Reading</option>
                        <option value="Is there anything unusual or out of place in this image?">Anomaly Detection</option>
                    </select>
                    <textarea id="promptText" style="margin-top:10px">Describe what you see in one sentence.</textarea>
                    <div class="form-group" style="margin-top:10px">
                        <label>Max Tokens</label>
                        <input type="number" id="maxTokens" value="512">
                    </div>
                    <button class="btn btn-secondary" id="updatePromptBtn" style="margin-top:10px">UPDATE PROMPT</button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="video-card">
                <div class="video-container">
                    <div class="video-controls">
                        <button class="video-control-btn" id="mirrorBtn" title="Flip Horizontal"><i data-lucide="flip-horizontal"></i> Mirror</button>
                        <button class="video-control-btn" id="expandBtn" title="Toggle Wide View"><i data-lucide="maximize"></i> Wide</button>
                    </div>
                    <video id="videoElement" autoplay playsinline muted></video>
                    <canvas id="overlayCanvas"></canvas>
                    <div class="video-overlay" id="videoOverlay"></div>
                </div>
            </div>

            <div class="result-card">
                <div class="result-header">
                    <div class="result-header-left">
                        <div class="result-title"><i data-lucide="bot" style="margin-right:8px;"></i> Analysis Results</div>
                        <div class="result-subtitle">Model: <span id="modelName" style="color:var(--accent-color)">--</span></div>
                    </div>
                    <div class="metrics-inline" id="metricsInline" style="display:none">
                        <div>Latency: <span id="latencyValue" class="metric-value">--</span>ms</div>
                        <div>Count: <span id="countValue" class="metric-value">--</span></div>
                    </div>
                </div>
                <div class="result-prompt" id="currentPrompt"></div>
                <div class="result-text" id="resultText">
                    <button class="markdown-toggle-embedded" id="markdownToggle">
                        <span id="markdownIcon"><i data-lucide="code"></i></span>
                        <span id="markdownText">Markdown</span>
                    </button>
                    <button class="copy-button-embedded" id="copyButton"><i data-lucide="copy"></i></button>
                    <div class="result-text-content" id="resultTextContent">Waiting for results...</div>
                </div>
            </div>

            <div class="result-card" id="systemStatsCard">
                <div class="result-header">
                    <div class="result-title"><i data-lucide="activity" style="margin-right:8px;"></i> System Diagnostics</div>
                    <div id="systemInfoHeader" style="font-size:12px; color:var(--text-muted)">Loading...</div>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header"><span class="stat-label">GPU</span><span class="stat-value" id="gpuUtil">--%</span></div>
                        <div class="stat-bar"><div class="stat-bar-fill" id="gpuUtilBar"></div></div>
                        <canvas id="gpuUtilSparkline" class="sparkline"></canvas>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header"><span class="stat-label">VRAM</span><span class="stat-value" id="vramUsage">-- GB</span></div>
                        <div class="stat-bar"><div class="stat-bar-fill" id="vramBar"></div></div>
                        <canvas id="vramSparkline" class="sparkline"></canvas>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header"><span class="stat-label">CPU</span><span class="stat-value" id="cpuUtil">--%</span></div>
                        <div class="stat-bar"><div class="stat-bar-fill" id="cpuBar"></div></div>
                        <canvas id="cpuSparkline" class="sparkline"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ELEMENTS
        const themeToggle = document.getElementById('themeToggle');
        const videoElement = document.getElementById('videoElement');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const connectionStatus = document.getElementById('connectionStatus');
        const resultText = document.getElementById('resultText');
        const currentPrompt = document.getElementById('currentPrompt');
        const metricsInline = document.getElementById('metricsInline');
        const markdownToggle = document.getElementById('markdownToggle');
        const copyButton = document.getElementById('copyButton');
        const modelSelect = document.getElementById('modelSelect');
        const cameraSelect = document.getElementById('cameraSelect');
        const refreshModelsBtn = document.getElementById('refreshModelsBtn');
        const modelName = document.getElementById('modelName');
        const apiBaseUrl = document.getElementById('apiBaseUrl');
        const apiKey = document.getElementById('apiKey');
        const apiPresetsBtn = document.getElementById('apiPresetsBtn');
        const apiPresetsMenu = document.getElementById('apiPresetsMenu');
        const promptText = document.getElementById('promptText');
        const maxTokens = document.getElementById('maxTokens');
        const processEvery = document.getElementById('processEvery');
        const maxLatency = document.getElementById('maxLatency');
        const videoOverlay = document.getElementById('videoOverlay');
        const overlayCanvas = document.getElementById('overlayCanvas');
        const ctx = overlayCanvas.getContext('2d');
        const promptPreset = document.getElementById('promptPreset');
        const expandBtn = document.getElementById('expandBtn');
        const mirrorBtn = document.getElementById('mirrorBtn');
        const layoutOrder = document.getElementById('layoutOrder');
        const overlayPosition = document.getElementById('overlayPosition');
        const popInToggle = document.getElementById('popInToggle');
        const glowToggle = document.getElementById('glowToggle');
        const yoloToggle = document.getElementById('yoloToggle');
        const gpuUpdateInterval = document.getElementById('gpuUpdateInterval');
        const videoCard = document.querySelector('.video-card');
        const resultCard = document.querySelector('.result-card');
        const statsCard = document.getElementById('systemStatsCard');
        const updatePromptBtn = document.getElementById('updatePromptBtn');

        // COLOR PALETTE FOR YOLO
        const classColors = {};
        function getClassColor(classId) {
            if (classColors[classId]) return classColors[classId];
            
            // Generate a high-contrast color based on class ID
            const hue = (classId * 137.508) % 360; // Use golden angle for even distribution
            const color = `hsl(${hue}, 70%, 50%)`;
            const rgb = hslToRgb(hue/360, 0.7, 0.5);
            classColors[classId] = {
                stroke: `rgba(${rgb[0]}, ${rgb[1]}, ${rgb[2]}, 0.9)`,
                fill: `rgba(${rgb[0]}, ${rgb[1]}, ${rgb[2]}, 0.45)`,
                label: `rgb(${rgb[0]}, ${rgb[1]}, ${rgb[2]})`
            };
            return classColors[classId];
        }

        function hslToRgb(h, s, l) {
            let r, g, b;
            if (s === 0) {
                r = g = b = l;
            } else {
                const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                const p = 2 * l - q;
                const hue2rgb = (p, q, t) => {
                    if (t < 0) t += 1;
                    if (t > 1) t -= 1;
                    if (t < 1/6) return p + (q - p) * 6 * t;
                    if (t < 1/2) return q;
                    if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                    return p;
                };
                r = hue2rgb(p, q, h + 1/3);
                g = hue2rgb(p, q, h);
                b = hue2rgb(p, q, h - 1/3);
            }
            return [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)];
        }

        let peerConnection = null;
        let localStream = null;
        let websocket = null;
        let lastText = '';
        let isAnalysisRunning = false;
        let markdownEnabled = localStorage.getItem('markdownEnabled') !== 'false';
        let isPiMode = false;

        // THEME
        function applyTheme(theme) {
            if (theme === 'light') document.body.classList.add('light-theme');
            else document.body.classList.remove('light-theme');
            lucide.createIcons();
        }
        themeToggle.addEventListener('click', () => {
            const isLight = document.body.classList.toggle('light-theme');
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
            lucide.createIcons();
        });
        if (localStorage.getItem('theme') === 'light') applyTheme('light');

        // PANEL TOGGLE
        function togglePanel(id) {
            document.getElementById(id).classList.toggle('collapsed');
            document.getElementById(id + 'Toggle').classList.toggle('collapsed');
        }
        function toggleApiKeyField() {
            document.getElementById('apiKeyField').classList.toggle('collapsed');
        }

        // WEBSOCKET
        function connectWebSocket() {
            const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            websocket = new WebSocket(`${protocol}//${location.host}/ws`);
            websocket.onopen = () => updateStatus('Connected', 'connected');
            websocket.onmessage = (e) => {
                const data = JSON.parse(e.data);
                if (data.type === 'vlm_response') {
                    if (data.text !== lastText) {
                        if (popInToggle.checked) {
                            resultText.classList.remove('fade', 'new-message');
                            void resultText.offsetWidth;
                            resultText.classList.add('new-message');
                        }
                        
                        if (glowToggle.checked) resultText.classList.add('with-glow');
                        else resultText.classList.remove('with-glow');

                        updateResultText(data.text);
                        videoOverlay.textContent = data.text;
                        lastText = data.text;
                    }
                    
                    // Draw YOLO detections
                    if (data.detections) {
                        drawDetections(data.detections);
                    } else {
                        // Clear canvas if no detections
                        ctx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
                    }

                    if (data.metrics) {
                        metricsInline.style.display = 'flex';
                        document.getElementById('latencyValue').textContent = Math.round(data.metrics.last_latency_ms);
                        document.getElementById('countValue').textContent = data.metrics.total_inferences;
                    }
                } else if (data.type === 'gpu_stats') {
                    updateGPUStats(data.stats);
                } else if (data.type === 'server_config') {
                    // Update UI with server config
                    isPiMode = !!data.pi_mode;
                    if (isPiMode) {
                        console.log('Pi Mode detected, applying optimizations');
                        if (!localStorage.getItem('processEvery')) processEvery.value = 150;
                        if (!localStorage.getItem('maxTokens')) maxTokens.value = 50;
                    }

                    if (data.model) {
                        modelName.textContent = data.model;
                        // Select the model in dropdown if it exists
                        const option = Array.from(modelSelect.options).find(o => o.value === data.model);
                        if (option) modelSelect.value = data.model;
                        else {
                            // If model not in list, add it as temporary option
                            const newOpt = new Option(data.model, data.model, true, true);
                            modelSelect.add(newOpt);
                        }
                    }
                    if (data.api_base) apiBaseUrl.value = data.api_base;
                    if (data.prompt) {
                        promptText.value = data.prompt;
                        currentPrompt.textContent = data.prompt;
                    }
                } else if (data.type === 'model_updated') {
                    modelName.textContent = data.model;
                    modelSelect.value = data.model;
                } else if (data.type === 'prompt_updated') {
                    promptText.value = data.prompt;
                    if (data.max_tokens) maxTokens.value = data.max_tokens;
                    currentPrompt.textContent = data.prompt;
                }
            };
            websocket.onclose = () => setTimeout(connectWebSocket, 2000);
        }

        // MODELS
        async function fetchModels() {
            const originalText = refreshModelsBtn.innerHTML;
            refreshModelsBtn.innerHTML = '<i data-lucide="loader-2" class="spin"></i>';
            lucide.createIcons();
            
            try {
                const base = apiBaseUrl.value.trim();
                const key = apiKey.value.trim();
                const url = `/models?api_base=${encodeURIComponent(base)}&api_key=${encodeURIComponent(key)}`;
                
                const res = await fetch(url);
                const data = await res.json();
                
                if (data.error) throw new Error(data.error);
                
                modelSelect.innerHTML = '';
                if (data.models && data.models.length > 0) {
                    data.models.forEach(m => {
                        const opt = new Option(m.name, m.id);
                        if (m.current) {
                            opt.selected = true;
                            modelName.textContent = m.id;
                        }
                        modelSelect.add(opt);
                    });
                } else {
                    modelSelect.innerHTML = '<option value="">No models found</option>';
                }
            } catch (e) {
                console.error('Error fetching models:', e);
                modelSelect.innerHTML = '<option value="">Error loading models</option>';
            } finally {
                refreshModelsBtn.innerHTML = originalText;
                lucide.createIcons();
            }
        }

        // CAMERAS
        async function fetchCameras() {
            try {
                // Request permission first to get device labels
                await navigator.mediaDevices.getUserMedia({ video: true });
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(d => d.kind === 'videoinput');
                
                cameraSelect.innerHTML = '';
                if (videoDevices.length > 0) {
                    videoDevices.forEach((d, i) => {
                        const opt = new Option(d.label || `Camera ${i + 1}`, d.deviceId);
                        cameraSelect.add(opt);
                    });
                } else {
                    cameraSelect.innerHTML = '<option value="">No cameras found</option>';
                }
            } catch (e) {
                console.error('Error fetching cameras:', e);
                cameraSelect.innerHTML = '<option value="">Permission denied</option>';
            }
        }

        // PRESETS
        apiPresetsBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            apiPresetsMenu.style.display = apiPresetsMenu.style.display === 'none' ? 'block' : 'none';
        });

        document.querySelectorAll('.api-preset-item').forEach(item => {
            item.addEventListener('click', () => {
                apiBaseUrl.value = item.dataset.url;
                apiPresetsMenu.style.display = 'none';
                fetchModels();
            });
        });

        document.addEventListener('click', () => {
            apiPresetsMenu.style.display = 'none';
        });

        modelSelect.addEventListener('change', () => {
            const model = modelSelect.value;
            if (model && websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.send(JSON.stringify({
                    type: 'update_model',
                    model: model,
                    api_base: apiBaseUrl.value.trim(),
                    api_key: apiKey.value.trim()
                }));
            }
        });

        refreshModelsBtn.addEventListener('click', fetchModels);

        // PROMPT EDITOR
        function updatePrompt() {
            const prompt = promptText.value.trim();
            const tokens = parseInt(maxTokens.value);
            if (prompt && websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.send(JSON.stringify({
                    type: 'update_prompt',
                    prompt: prompt,
                    max_tokens: tokens
                }));
                currentPrompt.textContent = prompt;
            }
        }

        promptText.addEventListener('change', updatePrompt);
        maxTokens.addEventListener('change', updatePrompt);
        
        promptPreset.addEventListener('change', () => {
            if (promptPreset.value) {
                promptText.value = promptPreset.value;
                updatePrompt();
            }
        });

        updatePromptBtn.addEventListener('click', updatePrompt);

        // SETTINGS HANDLERS
        layoutOrder.addEventListener('change', () => {
            if (layoutOrder.value === 'video-first') {
                videoCard.style.order = '1';
                resultCard.style.order = '2';
                statsCard.style.order = '3';
            } else {
                resultCard.style.order = '1';
                videoCard.style.order = '2';
                statsCard.style.order = '3';
            }
        });

        overlayPosition.addEventListener('change', () => {
            videoOverlay.className = 'video-overlay ' + overlayPosition.value;
            if (overlayPosition.value !== 'none') {
                videoOverlay.classList.add('show');
            } else {
                videoOverlay.classList.remove('show');
            }
        });

        maxLatency.addEventListener('change', () => {
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.send(JSON.stringify({
                    type: 'update_max_latency',
                    max_latency: parseFloat(maxLatency.value)
                }));
            }
        });

        processEvery.addEventListener('change', () => {
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.send(JSON.stringify({
                    type: 'update_processing',
                    process_every: parseInt(processEvery.value)
                }));
            }
        });

        yoloToggle.addEventListener('change', () => {
            if (!yoloToggle.checked) {
                ctx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
            }
        });

        gpuUpdateInterval.addEventListener('change', () => {
            // This is handled by the server loop sleep interval, 
            // but we could send a message to update it if the server supported it.
            // For now, it's just a UI placeholder or we can implement it.
        });

        // VIDEO CONTROLS
        mirrorBtn.addEventListener('click', () => {
            videoElement.classList.toggle('mirrored');
            mirrorBtn.classList.toggle('active');
        });

        expandBtn.addEventListener('click', () => {
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            const isHidden = sidebar.classList.toggle('hidden');
            mainContent.classList.toggle('expanded');
            
            if (isHidden) {
                expandBtn.innerHTML = '<i data-lucide="minimize"></i> Standard';
                expandBtn.classList.add('active');
            } else {
                expandBtn.innerHTML = '<i data-lucide="maximize"></i> Wide';
                expandBtn.classList.remove('active');
            }
            lucide.createIcons();
        });

        // RTSP TABS
        document.querySelectorAll('.input-source-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.input-source-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                const source = tab.dataset.source;
                if (source === 'webcam') {
                    document.getElementById('webcamControls').style.display = 'block';
                    document.getElementById('rtspControls').style.display = 'none';
                } else {
                    document.getElementById('webcamControls').style.display = 'none';
                    document.getElementById('rtspControls').style.display = 'block';
                }
            });
        });

        function updateResultText(text) {
            const content = document.getElementById('resultTextContent');
            if (markdownEnabled && typeof marked !== 'undefined') content.innerHTML = DOMPurify.sanitize(marked.parse(text));
            else content.textContent = text;
        }

        function updateStatus(msg, state) {
            connectionStatus.textContent = msg;
            connectionStatus.className = `status-badge ${state}`;
        }

        // GPU STATS
        function updateGPUStats(stats) {
            document.getElementById('systemInfoHeader').textContent = `${stats.hostname || 'System'} - ${stats.gpu_name || 'GPU'}`;
            if (stats.gpu_percent !== null) {
                document.getElementById('gpuUtil').textContent = stats.gpu_percent.toFixed(1) + '%';
                document.getElementById('gpuUtilBar').style.width = stats.gpu_percent + '%';
            }
            if (stats.vram_used_gb !== null) {
                document.getElementById('vramUsage').textContent = stats.vram_used_gb.toFixed(1) + ' GB';
                document.getElementById('vramBar').style.width = (stats.vram_percent || 0) + '%';
            }
            if (stats.cpu_percent !== null) {
                document.getElementById('cpuUtil').textContent = stats.cpu_percent.toFixed(1) + '%';
                document.getElementById('cpuBar').style.width = stats.cpu_percent + '%';
            }
        }

        // DRAW DETECTIONS
        function drawDetections(detections) {
            if (!yoloToggle.checked) return;

            // Resize canvas to match video display size
            const rect = videoElement.getBoundingClientRect();
            if (overlayCanvas.width !== rect.width || overlayCanvas.height !== rect.height) {
                overlayCanvas.width = rect.width;
                overlayCanvas.height = rect.height;
            }

            ctx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
            
            if (!detections || detections.length === 0) return;

            // Get actual video dimensions
            const videoWidth = videoElement.videoWidth;
            const videoHeight = videoElement.videoHeight;
            
            if (!videoWidth || !videoHeight) return;

            // Handle object-fit: cover/contain scaling
            const containerWidth = rect.width;
            const containerHeight = rect.height;
            const containerRatio = containerWidth / containerHeight;
            const videoRatio = videoWidth / videoHeight;

            let scale, offsetX = 0, offsetY = 0;
            const objectFit = window.getComputedStyle(videoElement).objectFit;

            if (objectFit === 'cover') {
                scale = Math.max(containerWidth / videoWidth, containerHeight / videoHeight);
                offsetX = (containerWidth - videoWidth * scale) / 2;
                offsetY = (containerHeight - videoHeight * scale) / 2;
            } else if (objectFit === 'contain') {
                scale = Math.min(containerWidth / videoWidth, containerHeight / videoHeight);
                offsetX = (containerWidth - videoWidth * scale) / 2;
                offsetY = (containerHeight - videoHeight * scale) / 2;
            } else {
                // Default to stretch/fill
                const scaleX = containerWidth / videoWidth;
                const scaleY = containerHeight / videoHeight;
                // Simplified case for non-uniform scaling
                drawDetectionsLegacy(detections, scaleX, scaleY, rect);
                return;
            }

            const isMirrored = videoElement.classList.contains('mirrored');

            detections.forEach(det => {
                const [x1, y1, x2, y2] = det.box;
                const label = det.label;
                const conf = det.conf;
                const colors = getClassColor(det.class_id || 0);

                // Map coordinates to canvas space
                let bx = x1 * scale + offsetX;
                const by = y1 * scale + offsetY;
                let bw = (x2 - x1) * scale;
                const bh = (y2 - y1) * scale;

                // Mirror if needed
                if (isMirrored) {
                    bx = containerWidth - bx - bw;
                }

                // Draw box
                ctx.strokeStyle = colors.stroke;
                ctx.lineWidth = 2;
                ctx.strokeRect(bx, by, bw, bh);

                // Draw label background
                ctx.fillStyle = colors.label;
                ctx.font = 'bold 12px sans-serif';
                const labelText = `${label} ${Math.round(conf * 100)}%`;
                const textWidth = ctx.measureText(labelText).width;
                ctx.fillRect(bx, by - 20, textWidth + 10, 20);

                // Draw label text
                ctx.fillStyle = 'white';
                ctx.fillText(labelText, bx + 5, by - 5);

                // Draw segmentation mask if available
                if (det.mask && det.mask.length > 0) {
                    ctx.beginPath();
                    det.mask.forEach((point, index) => {
                        let px = point[0] * scale + offsetX;
                        let py = point[1] * scale + offsetY;
                        
                        if (isMirrored) {
                            px = containerWidth - px;
                        }

                        if (index === 0) ctx.moveTo(px, py);
                        else ctx.lineTo(px, py);
                    });
                    ctx.closePath();
                    
                    // Semi-transparent fill for the mask - "paint" look
                    ctx.fillStyle = colors.fill; 
                    ctx.fill();
                    
                    // Outline the mask
                    ctx.strokeStyle = colors.stroke;
                    ctx.lineWidth = 1.5;
                    ctx.stroke();
                }
            });
        }

        // Legacy/Fallback draw function for simple XY scaling
        function drawDetectionsLegacy(detections, scaleX, scaleY, rect) {
            const isMirrored = videoElement.classList.contains('mirrored');
            detections.forEach(det => {
                const [x1, y1, x2, y2] = det.box;
                let bx = x1 * scaleX;
                const by = y1 * scaleY;
                let bw = (x2 - x1) * scaleX;
                const bh = (y2 - y1) * scaleY;
                if (isMirrored) bx = rect.width - bx - bw;
                ctx.strokeStyle = '#009CDE';
                ctx.lineWidth = 2;
                ctx.strokeRect(bx, by, bw, bh);
                
                // Simplified mask draw
                if (det.mask && det.mask.length > 0) {
                    ctx.beginPath();
                    det.mask.forEach((p, i) => {
                        let px = p[0] * scaleX;
                        let py = p[1] * scaleY;
                        if (isMirrored) px = rect.width - px;
                        if (i === 0) ctx.moveTo(px, py); else ctx.lineTo(px, py);
                    });
                    ctx.closePath();
                    ctx.fillStyle = 'rgba(0, 156, 222, 0.4)';
                    ctx.fill();
                }
            });
        }

        // START/STOP
        async function start() {
            try {
                const activeTab = document.querySelector('.input-source-tab.active');
                const isRtsp = activeTab && activeTab.dataset.source === 'rtsp';
                
                let body = {
                    sdp: '',
                    type: 'offer'
                };

                peerConnection = new RTCPeerConnection();
                
                // Handle incoming tracks (important for RTSP)
                peerConnection.ontrack = (event) => {
                    console.log('Received remote track:', event.track.kind);
                    if (event.track.kind === 'video') {
                        videoElement.srcObject = event.streams[0];
                    }
                };

                if (isRtsp) {
                    const rtspUrl = document.getElementById('rtspUrl').value.trim();
                    if (!rtspUrl) {
                        alert('Please enter an RTSP URL');
                        return;
                    }
                    body.rtsp_url = rtspUrl;
                } else {
                    const constraints = {
                        video: {
                            deviceId: cameraSelect.value ? { exact: cameraSelect.value } : undefined,
                            width: isPiMode ? { ideal: 640 } : { ideal: 1280 },
                            height: isPiMode ? { ideal: 480 } : { ideal: 720 },
                            aspectRatio: { ideal: 16 / 9 }
                        }
                    };
                    localStream = await navigator.mediaDevices.getUserMedia(constraints);
                    // For webcam, we can show local stream for zero latency
                    videoElement.srcObject = localStream;
                    
                    localStream.getTracks().forEach(t => peerConnection.addTrack(t, localStream));
                }

                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                body.sdp = offer.sdp;
                body.type = offer.type;

                updateStatus('Connecting...', 'connecting');
                
                const res = await fetch('/offer', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });
                
                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.error || 'Failed to start streaming');
                }
                
                const answer = await res.json();
                await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));

                startBtn.disabled = true; 
                stopBtn.disabled = false; 
                isAnalysisRunning = true;
                updateStatus(isRtsp ? 'RTSP Active' : 'Streaming', 'connected');
            } catch (e) { 
                console.error(e); 
                updateStatus('Error', 'disconnected');
                alert('Error: ' + e.message);
            }
        }

        function stop() {
            if (localStream) localStream.getTracks().forEach(t => t.stop());
            if (peerConnection) peerConnection.close();
            videoElement.srcObject = null;
            startBtn.disabled = false; stopBtn.disabled = true; isAnalysisRunning = false;
        }

        startBtn.addEventListener('click', start);
        stopBtn.addEventListener('click', stop);
        document.getElementById('settingsBtn').addEventListener('click', () => document.getElementById('settingsModal').classList.add('show'));
        document.getElementById('settingsClose').addEventListener('click', () => document.getElementById('settingsModal').classList.remove('show'));

        // SIDEBAR RESIZE
        const sidebar = document.getElementById('sidebar');
        const resizeHandle = document.getElementById('sidebarResizeHandle');
        let isResizing = false;

        resizeHandle.addEventListener('mousedown', (e) => {
            isResizing = true;
            resizeHandle.classList.add('dragging');
            document.body.style.cursor = 'ew-resize';
            document.body.style.userSelect = 'none';
            e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            const newWidth = e.clientX;
            if (newWidth >= 250 && newWidth <= 600) {
                sidebar.style.width = newWidth + 'px';
            }
        });

        document.addEventListener('mouseup', () => {
            if (isResizing) {
                isResizing = false;
                resizeHandle.classList.remove('dragging');
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
            }
        });

        window.onload = () => {
            connectWebSocket();
            fetchModels();
            fetchCameras();
            lucide.createIcons();
        };
    </script>
</body>
</html>
